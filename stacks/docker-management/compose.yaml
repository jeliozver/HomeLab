services:
  dockerproxy:
    container_name: dockerproxy
    image: ghcr.io/tecnativa/docker-socket-proxy:latest
    restart: unless-stopped
    networks:
      - proxy-net
    ports:
      - "127.0.0.1:2375:2375"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - INFO=1        # Docker host info (OS, storage driver, limits)
      - EVENTS=1      # Docker events
      - VERSION=1     # Docker engine + API version
      - PING=1        # Health check endpoint

      - CONTAINERS=1  # List / inspect containers, logs, stats
      - ALLOW_START=0      # Containers stop
      - ALLOW_STOP=0       # Containers stop
      - ALLOW_RESTARTS=0   # Containers stop | restart | kill
      - IMAGES=1      # List / inspect images
      - NETWORKS=1    # List / inspect Docker networks
      - VOLUMES=1     # List / inspect volumes

      - SWARM=0       # Swarm control
      - NODES=0       # Swarm nodes
      - SERVICES=0    # Swarm services
      - TASKS=0       # Swarm task visibility

      - EXEC=0        # Execute commands
      - POST=0        # Authentik needs to automatically create and manage outposts
      - AUTH=0        # Authentication APIs
      - SECRETS=0     # Docker secrets access
    security_opt:
      - no-new-privileges:true
  portainer:
    container_name: portainer
    image: portainer/portainer-ce:lts
    restart: unless-stopped
    depends_on:
      - dockerproxy
    networks:
      - proxy-net
    ports:
      - "9443:9443"
    volumes:
      - portainer_data:/data
    command: -H tcp://dockerproxy:2375
    security_opt:
      - no-new-privileges:true
  dozzle:
    container_name: dozzle
    image: amir20/dozzle:latest
    restart: unless-stopped
    depends_on:
      - dockerproxy
    networks:
      - proxy-net
    environment:
      - DOZZLE_REMOTE_HOST=tcp://dockerproxy:2375
      - DOZZLE_AUTH_PROVIDER=forward-proxy
      - DOZZLE_AUTH_HEADER_USER=X-authentik-username
      - DOZZLE_AUTH_HEADER_EMAIL=X-authentik-email
      - DOZZLE_AUTH_HEADER_NAME=X-authentik-name
      - DOZZLE_AUTH_HEADER_FILTER=X-authentik-group
      - DOZZLE_AUTH_HEADER_ROLES=X-authentik-roles
    security_opt:
      - no-new-privileges:true
  diun:
    container_name: diun
    image: crazymax/diun:latest
    restart: unless-stopped
    depends_on:
      - dockerproxy
    networks:
      - proxy-net
    volumes:
      - ./data:/data
    environment:
      - TZ=${TZ}
      - DIUN_WATCH_WORKERS=20
      - DIUN_WATCH_SCHEDULE=0 */6 * * *
      - DIUN_WATCH_JITTER=30s
      - DIUN_PROVIDERS_DOCKER=true
      - DIUN_PROVIDERS_DOCKER_WATCHBYDEFAULT=true
      - DIUN_PROVIDERS_DOCKER_ENDPOINT=tcp://dockerproxy:2375
      - DIUN_NOTIF_DISCORD_WEBHOOKURL=${DIUN_NOTIF_DISCORD_WEBHOOKURL}
      - DIUN_NOTIF_DISCORD_RENDEREMBEDS=true
      - DIUN_NOTIF_DISCORD_RENDERFIELDS=true
      - DIUN_NOTIF_DISCORD_TIMEOUT=10s
    labels:
      - diun.enable=true
    command: serve

networks:
  proxy-net:
    external: true

volumes:
  portainer_data:
